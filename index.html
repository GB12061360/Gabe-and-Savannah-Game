<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-950 text-slate-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Team Bear · Studio Edition</title>
    <meta name="theme-color" content="#020617" />
    <link rel="manifest" href="manifest.json" />
    <script>
      const BUILD_VERSION = "2024.06.09a";
    </script>
    <link id="tailwind-cdn" rel="stylesheet" href="" />
    <script>
      document.getElementById("tailwind-cdn").href = `https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css?v=${BUILD_VERSION}`;
    </script>
    <style>
      html,
      body {
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }
      .glass-panel {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.82), rgba(15, 23, 42, 0.55));
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 30px 120px rgba(2, 6, 23, 0.65);
        backdrop-filter: blur(22px);
      }
      .stat-bar {
        position: relative;
        overflow: hidden;
      }
      .stat-bar::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
        pointer-events: none;
      }
      .tile-grid {
        display: grid;
        grid-template-columns: repeat(8, minmax(0, 1fr));
        grid-template-rows: repeat(5, minmax(0, 1fr));
        position: relative;
      }
      .bear-sprite {
        width: 96px;
        height: 96px;
        position: absolute;
        transform-origin: 50% 100%;
        transition: transform 0.15s ease;
      }
      .bear-sprite[data-facing="left"] {
        transform: scaleX(-1);
      }
      .bear-sprite::before {
        content: "";
        position: absolute;
        inset: 12px 18px 8px 18px;
        border-radius: 28px;
        background: radial-gradient(circle at 40% 30%, rgba(255, 255, 255, 0.12), rgba(59, 130, 246, 0.05) 70%, rgba(15, 23, 42, 0.9));
        border: 1px solid rgba(148, 163, 184, 0.18);
      }
      .decor-item {
        position: absolute;
        width: 88px;
        height: 88px;
        border-radius: 22px;
        background: linear-gradient(135deg, rgba(148, 163, 184, 0.1), rgba(59, 130, 246, 0.05));
        border: 1px solid rgba(148, 163, 184, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: grab;
      }
      .decor-item:hover {
        transform: translateY(-6px);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.45);
      }
      .decor-item::after {
        content: "Move · Sell";
        position: absolute;
        bottom: -22px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.625rem;
        color: rgba(148, 163, 184, 0.8);
        pointer-events: none;
      }
      .floating-text {
        position: absolute;
        animation: floatUp 0.8s ease forwards;
        pointer-events: none;
      }
      @keyframes floatUp {
        0% {
          opacity: 0;
          transform: translate(-50%, 0);
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -36px);
        }
      }
      .button-press {
        transition: transform 0.15s ease;
      }
      .button-press:active {
        transform: scale(0.96);
      }
      .rarity-border-common {
        box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.3);
      }
      .rarity-border-rare {
        box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.45);
      }
      .rarity-border-epic {
        box-shadow: 0 0 0 2px rgba(196, 181, 253, 0.5);
      }
      .rarity-border-legendary {
        box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.6);
      }
      .modal-backdrop {
        background: rgba(2, 6, 23, 0.75);
        backdrop-filter: blur(14px);
      }
      .pack-stage {
        perspective: 1200px;
      }
      .card-flip {
        transform-style: preserve-3d;
        transition: transform 0.8s ease;
      }
      .card-flip[data-flipped="true"] {
        transform: rotateY(180deg);
      }
      .card-face,
      .card-back {
        position: absolute;
        inset: 0;
        backface-visibility: hidden;
        border-radius: 14px;
        overflow: hidden;
      }
      .card-back {
        background: linear-gradient(135deg, rgba(30, 64, 175, 0.9), rgba(59, 130, 246, 0.5));
      }
      .card-face {
        transform: rotateY(180deg);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 18px;
      }
      .sheen::after {
        content: "";
        position: absolute;
        inset: -40%;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0));
        transform: translateX(-120%) rotate(20deg);
        animation: sheenMove 2.4s linear infinite;
      }
      @keyframes sheenMove {
        0% {
          transform: translateX(-120%) rotate(20deg);
        }
        100% {
          transform: translateX(120%) rotate(20deg);
        }
      }
    </style>
  </head>
  <body class="h-full">
    <div id="app" class="mx-auto flex h-full max-w-6xl flex-col gap-6 px-6 py-8">
      <header class="glass-panel flex flex-col gap-4 rounded-3xl px-6 py-5 shadow-xl">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-wrap items-center gap-4">
            <div>
              <h1 id="bear-name" class="text-2xl font-semibold text-slate-50">Team Bear</h1>
              <p id="bear-lineage" class="text-xs uppercase tracking-[0.4em] text-slate-400">Studio Edition</p>
            </div>
            <span id="bear-rarity" class="rounded-full border border-slate-600 px-3 py-1 text-xs uppercase tracking-wide text-slate-200">Common</span>
            <span id="bear-stage" class="rounded-full border border-emerald-600/40 bg-emerald-600/10 px-3 py-1 text-xs uppercase tracking-wide text-emerald-200">Cub</span>
            <span id="bear-duty" class="rounded-full border border-cyan-600/30 px-3 py-1 text-xs uppercase tracking-wide text-cyan-200">Off Duty</span>
          </div>
          <div class="flex flex-wrap items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-slate-400">Credits</span>
              <span id="credits" class="text-lg font-semibold text-amber-300">0</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-400">Vouchers</span>
              <span id="vouchers" class="text-lg font-semibold text-indigo-200">0</span>
            </div>
            <button id="settings-btn" class="button-press rounded-full bg-slate-800/70 px-3 py-1 text-xs uppercase tracking-wide text-slate-300 ring-1 ring-slate-600/50 hover:bg-slate-700/70">Settings</button>
          </div>
        </div>
        <div id="kjv-line" class="hidden text-sm italic text-slate-300"></div>
      </header>

      <main class="flex flex-1 flex-col gap-6 md:flex-row">
        <section class="glass-panel relative flex-1 rounded-3xl p-6">
          <button id="decor-btn" class="absolute right-8 top-8 z-20 rounded-full bg-slate-900/80 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300 ring-1 ring-slate-600/60 hover:bg-slate-800/80">Decor</button>
          <div class="tile-grid aspect-[8/5] rounded-2xl bg-gradient-to-b from-slate-800/60 via-slate-900/70 to-slate-950/80" id="room-grid"></div>
        </section>
        <aside class="flex w-full flex-col gap-4 md:w-80">
          <section class="glass-panel rounded-3xl p-5">
            <h2 class="text-sm uppercase tracking-[0.4em] text-slate-400">Vitals</h2>
            <div class="mt-4 space-y-3" id="stats"></div>
          </section>
          <section class="glass-panel rounded-3xl p-5">
            <div class="flex items-center justify-between">
              <h2 class="text-sm uppercase tracking-[0.4em] text-slate-400">Side Gigs</h2>
              <span id="sidegig-remaining" class="text-xs text-slate-400"></span>
            </div>
            <div class="mt-4 grid gap-3" id="mini-game-list"></div>
          </section>
          <section class="glass-panel rounded-3xl p-5" id="milestone-panel">
            <h2 class="text-sm uppercase tracking-[0.4em] text-slate-400">Milestones</h2>
            <div class="mt-4 space-y-3" id="milestones"></div>
          </section>
        </aside>
      </main>

      <footer class="glass-panel flex flex-col gap-4 rounded-3xl px-6 py-5">
        <div class="flex flex-wrap justify-center gap-3 text-sm text-slate-400">
          <button class="action-btn button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700" data-action="feed">Feed</button>
          <button class="action-btn button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700" data-action="clean">Clean</button>
          <button class="action-btn button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700" data-action="play">Play</button>
          <button class="action-btn button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700" data-action="rest">Rest</button>
          <button id="quick-care" class="button-press rounded-full bg-amber-500/20 px-4 py-2 font-semibold text-amber-200 ring-1 ring-amber-400/60 hover:bg-amber-500/30">Quick Care · 40 Credits</button>
          <button id="contracts-btn" class="button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700">Contracts</button>
          <button id="packs-btn" class="button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700">Packs</button>
          <button id="wardrobe-btn" class="button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700">Wardrobe</button>
          <button id="quests-btn" class="button-press rounded-full bg-slate-800/70 px-4 py-2 font-medium text-slate-100 hover:bg-slate-700">Quests</button>
        </div>
        <p class="text-center text-xs uppercase tracking-[0.4em] text-slate-500">Build <span id="build-version"></span></p>
      </footer>
    </div>

    <div id="modal-root"></div>
    <div id="toast-root" class="fixed inset-x-0 top-4 z-50 flex flex-col items-center gap-3"></div>

    <script>
      const STORAGE_KEY = "team_bear_v3";
      const SCHEMA_VERSION = 3;
      const GRID_CONFIG = { cols: 8, rows: 5, tile: 96 };
      const RARITY_DATA = {
        common: { label: "Common", multiplier: 1.0, badge: "bg-slate-700/60 text-slate-200", border: "rarity-border-common" },
        rare: { label: "Rare", multiplier: 1.2, badge: "bg-sky-700/60 text-sky-200", border: "rarity-border-rare" },
        epic: { label: "Epic", multiplier: 1.5, badge: "bg-violet-700/60 text-violet-200", border: "rarity-border-epic" },
        legendary: { label: "Legendary", multiplier: 1.8, badge: "bg-amber-600/20 text-amber-200", border: "rarity-border-legendary" },
      };
      const CONTRACT_TYPES = [
        { id: "brief", label: "30m Precision Brief", durationMinutes: 30, energyRate: 1, payout: 120 },
        { id: "audit", label: "2h Compliance Audit", durationMinutes: 120, energyRate: 1.5, payout: 600 },
        { id: "overnight", label: "8h Overnight Vigil", durationMinutes: 480, energyRate: 2, payout: 2600 },
      ];
      const PACK_CATALOG = {
        standard: {
          name: "Standard Pack",
          draws: 3,
          price: 240,
          odds: { common: 0.6, rare: 0.26, epic: 0.11, legendary: 0.03 },
        },
        elite: {
          name: "Elite Pack",
          draws: 4,
          price: 540,
          odds: { common: 0.45, rare: 0.34, epic: 0.17, legendary: 0.04 },
        },
        premier: {
          name: "Premier Pack",
          draws: 5,
          price: 900,
          odds: { common: 0.34, rare: 0.34, epic: 0.23, legendary: 0.09 },
        },
      };
      const ACCESSORY_LIBRARY = [
        { id: "fedora", slot: "head", name: "Felt Fedora", rarity: "rare", flavor: "+2 morale cap" },
        { id: "monocle", slot: "head", name: "Steel Monocle", rarity: "legendary", flavor: "+3 morale cap" },
        { id: "wrap", slot: "body", name: "Midnight Wrap", rarity: "epic", flavor: "+5 morale cap" },
        { id: "band", slot: "neck", name: "Midday Band", rarity: "rare", flavor: "+1 income" },
        { id: "gloves", slot: "paws", name: "Artisan Gloves", rarity: "rare", flavor: "+2 cleanliness cap" },
        { id: "warm", slot: "colorway", name: "Warm Undertone", rarity: "epic", flavor: "Rich finish" },
      ];
      const DECOR_LIBRARY = [
        { id: "planter", name: "Eucalyptus Planter", boosts: { moraleCap: 1 } },
        { id: "record", name: "Vinyl Console", boosts: { moraleCap: 2 } },
        { id: "lamp", name: "Amber Floor Lamp", boosts: { energyCap: 1 } },
        { id: "espresso", name: "Espresso Bar", boosts: { moraleCap: 2, energyCap: 1 } },
      ];
      const MINI_GAMES = [
        { id: "rhythm", name: "Timberline Rhythm", desc: "On-beat taps with streak multiplier", maxPerHour: 2, maxPerDay: 5 },
        { id: "fish", name: "Riverside Fishing", desc: "Time the strike bar for rare catches", maxPerHour: 2, maxPerDay: 5 },
        { id: "courier", name: "Courier Run", desc: "Three-lane sprint, avoid debris", maxPerHour: 1, maxPerDay: 5 },
        { id: "memory", name: "Memory Match", desc: "4×3 pairs — coming soon", stub: true },
        { id: "workshop", name: "Workshop", desc: "Precision stop challenge — coming soon", stub: true },
      ];
      const MILESTONE_DEFS = {
        professional1: {
          name: "Professional I",
          description: "Complete 3 contracts.",
          reward: "+200 Credits",
          check: (s) => (s.stats.contractsCompleted || 0) >= 3,
        },
        craftsman: {
          name: "Craftsman",
          description: "Perfect Timberline Rhythm once.",
          reward: "Standard Pack",
          check: (s) => s.miniGames.history?.rhythmPerfect || false,
        },
        steadyHand: {
          name: "Steady Hand",
          description: "Keep all stats ≥ 70 for 48 cumulative hours.",
          reward: "+1 Elite Decor",
          check: (s) => (s.stats.steadyMinutes || 0) >= 60 * 48,
        },
        homestead2: {
          name: "Homestead II",
          description: "Place 10 decor items and reach Room Level 3.",
          reward: "Standard Pack",
          check: (s) => s.room.decor.length >= 10 && (s.room.level || 1) >= 3,
        },
      };
      const DEFAULT_VERSES = [
        "Iron sharpeneth iron; so a man sharpeneth the countenance of his friend. — Proverbs 27:17",
        "And let us not be weary in well doing: for in due season we shall reap, if we faint not. — Galatians 6:9",
        "Bear ye one another's burdens, and so fulfil the law of Christ. — Galatians 6:2",
      ];
      const STAT_NAMES = [
        { key: "energy", label: "Energy", tone: "from-amber-400 to-amber-600" },
        { key: "cleanliness", label: "Cleanliness", tone: "from-cyan-400 to-cyan-600" },
        { key: "morale", label: "Morale", tone: "from-violet-400 to-violet-600" },
      ];

      let state = loadState();
      let lastFrame = performance.now();
      let realtimeAccumulator = 0;
      let saveQueued = false;
      let firebaseMirror = null;
      const roomGrid = document.getElementById("room-grid");
      const bearElement = createBearSprite();
      const roomEngine = new RoomEngine(roomGrid, bearElement);
      let decorDrag = null;
      let decorGhost = null;
      let decorMenu = null;
      document.getElementById("build-version").textContent = BUILD_VERSION;

      if (window.BEAR_FIREBASE_CONFIG) {
        initFirebase(window.BEAR_FIREBASE_CONFIG).catch((err) => console.warn("Firebase init failed", err));
      }

      applyOfflineProgress(state);
      queueSave();
      render();
      requestAnimationFrame(mainLoop);

      document.getElementById("quick-care").addEventListener("click", () => {
        quickCare(state);
        render();
        queueSave();
      });

      document.querySelectorAll(".action-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          handleBasicAction(btn.dataset.action);
        });
      });

      document.getElementById("contracts-btn").addEventListener("click", () => openContractsModal());
      document.getElementById("packs-btn").addEventListener("click", () => openPackModal());
      document.getElementById("wardrobe-btn").addEventListener("click", () => openWardrobeModal());
      document.getElementById("quests-btn").addEventListener("click", () => openQuestsModal());
      document.getElementById("settings-btn").addEventListener("click", () => openSettingsModal());
      document.getElementById("decor-btn").addEventListener("click", () => openDecorModal());

      document.addEventListener("pointermove", (ev) => {
        if (!decorDrag || !decorGhost) return;
        updateDecorGhost(ev.clientX, ev.clientY);
      });
      document.addEventListener("pointerup", (ev) => {
        if (!decorDrag) return;
        completeDecorDrag(ev.clientX, ev.clientY);
      });
      roomGrid.addEventListener("contextmenu", (ev) => {
        const target = ev.target.closest(".decor-item");
        if (!target) return;
        ev.preventDefault();
        const index = Number(target.dataset.index);
        showDecorMenu(index, ev.clientX, ev.clientY);
      });
      window.addEventListener("resize", () => renderDecor());
      requestAnimationFrame(() => renderDecor());

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return migrateSave(createDefaultState());
        }
        try {
          const parsed = JSON.parse(raw);
          return migrateSave(parsed);
        } catch (err) {
          console.warn("Save corrupted, resetting.", err);
          return migrateSave(createDefaultState());
        }
      }

      function createDefaultState() {
        return {
          meta: { schemaVersion: SCHEMA_VERSION, lastSaved: Date.now(), homeCode: null },
          credits: 400,
          vouchers: 0,
          settings: { showKJV: false, sfx: 0.5, music: 0.2 },
          bear: {
            name: "Ash",
            rarity: "rare",
            stage: "cub",
            ageMinutes: 0,
            pos: { x: 3, y: 2 },
            facing: "right",
            stats: { energy: 82, cleanliness: 76, morale: 80 },
            job: { id: null, contractEndsAt: 0, payout: 0, startedAt: 0 },
          },
          room: { gridW: GRID_CONFIG.cols, gridH: GRID_CONFIG.rows, level: 1, decor: [] },
          accessories: {
            owned: [{ id: "fedora", slot: "head", rarity: "rare", name: "Felt Fedora", flavor: "+2 morale cap" }],
            equipped: { head: null, neck: null, body: null, paws: null, colorway: null },
          },
          cards: { collection: [] },
          miniGames: { playsToday: {}, lastPlayedAt: {}, history: {} },
          stats: { contractsCompleted: 0, steadyMinutes: 0 },
          milestones: {},
          compliments: { sentToday: false, receivedToday: false, streakDays: 0, lastSent: 0, lastReceived: 0, streakUpdated: 0 },
          quests: { active: [], archive: [] },
          versesKJV: DEFAULT_VERSES,
        };
      }

      function migrateSave(current) {
        const state = JSON.parse(JSON.stringify(current || {}));
        if (!state.meta) state.meta = { lastSaved: Date.now(), schemaVersion: SCHEMA_VERSION, homeCode: null };
        state.meta.schemaVersion = SCHEMA_VERSION;
        if (!state.settings) state.settings = { showKJV: false, sfx: 0.5, music: 0.2 };
        if (!state.bear) {
          state.bear = createDefaultState().bear;
        } else {
          state.bear.pos = state.bear.pos || { x: 3, y: 2 };
          state.bear.facing = state.bear.facing || "right";
          state.bear.stage = state.bear.stage || "cub";
          if (!state.bear.stats) state.bear.stats = { energy: 70, cleanliness: 70, morale: 70 };
          state.bear.job = state.bear.job || { id: null, contractEndsAt: 0, payout: 0, startedAt: 0 };
        }
        if (!state.room) state.room = { gridW: GRID_CONFIG.cols, gridH: GRID_CONFIG.rows, level: 1, decor: [] };
        if (!Array.isArray(state.room.decor)) state.room.decor = [];
        if (!state.accessories) state.accessories = createDefaultState().accessories;
        if (!state.accessories.equipped) {
          state.accessories.equipped = { head: null, neck: null, body: null, paws: null, colorway: null };
        } else {
          ["head", "neck", "body", "paws", "colorway"].forEach((slot) => {
            if (state.accessories.equipped[slot] === undefined) state.accessories.equipped[slot] = null;
          });
        }
        if (!state.cards) state.cards = { collection: [] };
        if (!state.miniGames) state.miniGames = { playsToday: {}, lastPlayedAt: {}, history: {} };
        if (!state.stats) state.stats = { contractsCompleted: 0, steadyMinutes: 0 };
        if (!state.milestones) state.milestones = {};
        if (!state.compliments) state.compliments = { sentToday: false, receivedToday: false, streakDays: 0, lastSent: 0, lastReceived: 0, streakUpdated: 0 };
        if (!state.quests) state.quests = { active: [], archive: [] };
        if (!state.versesKJV || !Array.isArray(state.versesKJV)) state.versesKJV = DEFAULT_VERSES;
        return state;
      }

      function applyOfflineProgress(state) {
        const now = Date.now();
        const minutesElapsed = Math.floor((now - (state.meta.lastSaved || now)) / 60000);
        if (minutesElapsed <= 0) return;
        const decayRateIdle = 1 / 10;
        const decayRateContract = 1 / 5;
        const stats = state.bear.stats;
        const contract = state.bear.job;
        let remainingMinutes = minutesElapsed;
        if (contract && contract.id && contract.contractEndsAt > state.meta.lastSaved) {
          const contractEndMinutes = Math.floor((contract.contractEndsAt - state.meta.lastSaved) / 60000);
          const activeMinutes = Math.min(contractEndMinutes, minutesElapsed);
          const contractDecay = activeMinutes * decayRateContract;
          stats.energy = Math.max(0, stats.energy - contractDecay);
          stats.cleanliness = Math.max(0, stats.cleanliness - contractDecay * 0.6);
          stats.morale = Math.max(0, stats.morale - contractDecay * 0.4);
          remainingMinutes -= activeMinutes;
          if (now >= contract.contractEndsAt) {
            state.credits += contract.payout;
            state.stats.contractsCompleted = (state.stats.contractsCompleted || 0) + 1;
            showToast(`Contract cleared · +${contract.payout} credits`, "success");
            contract.id = null;
            contract.contractEndsAt = 0;
            contract.payout = 0;
            contract.startedAt = 0;
          }
        }
        if (remainingMinutes > 0) {
          const decay = remainingMinutes * decayRateIdle;
          stats.energy = Math.max(0, stats.energy - decay);
          stats.cleanliness = Math.max(0, stats.cleanliness - decay);
          stats.morale = Math.max(0, stats.morale - decay);
        }
        if (isOnDuty(state)) {
          const earned = incomePerMinute(state) * minutesElapsed;
          state.credits += Math.floor(earned);
        }
        stats.energy = clamp(stats.energy, 0, statMax("energy"));
        stats.cleanliness = clamp(stats.cleanliness, 0, statMax("cleanliness"));
        stats.morale = clamp(stats.morale, 0, statMax("morale"));
        state.bear.ageMinutes += minutesElapsed;
        updateBearStage(state);
        trackSteadyProgress(state, minutesElapsed);
        state.meta.lastSaved = now;
      }

      function incomePerMinute(state) {
        const base = 2;
        const rarity = RARITY_DATA[state.bear.rarity]?.multiplier || 1;
        const penalty = Object.values(state.bear.stats).some((v) => v < 40) ? 0.75 : 1;
        return base * rarity * penalty;
      }

      function quickCare(state) {
        if (state.credits < 40) {
          showToast("Not enough credits for Quick Care.", "warn");
          return false;
        }
        state.credits -= 40;
        const stats = state.bear.stats;
        STAT_NAMES.forEach((entry) => {
          stats[entry.key] = clamp(stats[entry.key] + 10, 0, statMax(entry.key));
        });
        spawnFloatingText("+10", { x: state.bear.pos.x, y: state.bear.pos.y });
        showToast("Quick Care applied", "success");
        trackSteadyProgress(state, 1);
        return true;
      }

      function SpriteAnimator(element) {
        this.element = element;
        this.state = "idle";
        this.elapsed = 0;
      }
      SpriteAnimator.prototype.setState = function (name) {
        if (this.state !== name) {
          this.state = name;
          this.elapsed = 0;
        }
      };
      SpriteAnimator.prototype.update = function () {};
      const bearAnimator = new SpriteAnimator(bearElement);

      function RoomEngine(container, bearNode) {
        this.container = container;
        this.bear = bearNode;
        this.container.appendChild(bearNode);
        this.target = { x: state.bear.pos.x, y: state.bear.pos.y };
        this.moveTimer = Date.now() + 4000;
      }
      RoomEngine.prototype.pickNext = function () {
        this.moveTimer = Date.now() + 6000 + Math.random() * 6000;
        this.target = { x: Math.floor(Math.random() * GRID_CONFIG.cols), y: Math.floor(Math.random() * GRID_CONFIG.rows) };
      };
      RoomEngine.prototype.update = function (delta) {
        const now = Date.now();
        if (now > this.moveTimer) {
          this.pickNext();
        }
        const pos = state.bear.pos;
        const speed = delta / 1000 * 1.2;
        const dx = this.target.x - pos.x;
        const dy = this.target.y - pos.y;
        const dist = Math.hypot(dx, dy);
        if (dist > 0.05) {
          pos.x += (dx / dist) * speed;
          pos.y += (dy / dist) * speed;
          state.bear.facing = dx < 0 ? "left" : "right";
          bearAnimator.setState("walk");
        } else {
          bearAnimator.setState("idle");
        }
        const rect = this.container.getBoundingClientRect();
        const tileW = rect.width / GRID_CONFIG.cols;
        const tileH = rect.height / GRID_CONFIG.rows;
        this.bear.style.left = `${pos.x * tileW}px`;
        this.bear.style.top = `${pos.y * tileH}px`;
        this.bear.dataset.facing = state.bear.facing;
      };

      function equipAccessory(slot, itemId) {
        const ownedItem = state.accessories.owned.find((item) => item.id === itemId);
        if (!ownedItem) return;
        if (state.accessories.equipped[slot] === itemId) {
          state.accessories.equipped[slot] = null;
          showToast(`${ownedItem.name} removed`, "info");
        } else {
          state.accessories.equipped[slot] = itemId;
          showToast(`${ownedItem.name} equipped`, "success");
        }
        queueSave();
        render();
      }

      function unequipAccessory(slot) {
        state.accessories.equipped[slot] = null;
        showToast(`${slot} cleared`, "info");
        queueSave();
        render();
      }

      function openPack(type) {
        const pack = PACK_CATALOG[type];
        if (!pack) return;
        if (state.credits < pack.price) {
          showToast("Not enough credits", "warn");
          return;
        }
        state.credits -= pack.price;
        const pulls = [];
        for (let i = 0; i < pack.draws; i++) {
          const rarity = rollRarity(pack.odds);
          const pool = ACCESSORY_LIBRARY.filter((item) => item.rarity === rarity);
          const drawn = pool[Math.floor(Math.random() * pool.length)] || ACCESSORY_LIBRARY[Math.floor(Math.random() * ACCESSORY_LIBRARY.length)];
          const owned = state.accessories.owned.find((item) => item.id === drawn.id);
          if (!owned) {
            state.accessories.owned.push({ ...drawn });
            pulls.push({ ...drawn, duplicate: false });
          } else {
            state.vouchers += 1;
            pulls.push({ ...drawn, duplicate: true });
          }
        }
        queueSave();
        render();
        showPackReveal(pack, pulls);
      }

      function rollRarity(odds) {
        const r = Math.random();
        let acc = 0;
        for (const key of ["legendary", "epic", "rare", "common"]) {
          acc += odds[key];
          if (r <= acc) return key;
        }
        return "common";
      }

      function playMiniGame(id) {
        const game = MINI_GAMES.find((g) => g.id === id);
        if (!game || game.stub) return;
        const now = Date.now();
        const plays = state.miniGames.playsToday[id] || 0;
        const lastPlayed = state.miniGames.lastPlayedAt[id] || 0;
        const hoursSince = (now - lastPlayed) / 3600000;
        const dailyTotal = Object.values(state.miniGames.playsToday).reduce((a, b) => a + b, 0);
        if (dailyTotal >= 5) {
          showToast("Side gig cap reached for today", "warn");
          return;
        }
        if (plays >= game.maxPerDay) {
          showToast(`${game.name} · Daily cap reached`, "warn");
          return;
        }
        if (plays >= game.maxPerHour && hoursSince < 1) {
          showToast(`${game.name} · Come back soon`, "info");
          return;
        }
        openMiniGameModal(game);
      }

      function sharedQuestCreate(template) {
        const id = `quest-${Date.now()}`;
        const quest = {
          id,
          title: template?.title || "Shared intention",
          description: template?.description || "Draft a new micro-ritual together.",
          reward: template?.reward || { type: "decor", id: "planter" },
          createdAt: Date.now(),
          completed: false,
        };
        state.quests.active.push(quest);
        queueSave();
        render();
        return quest;
      }

      function sharedQuestComplete(id, memory) {
        const quest = state.quests.active.find((q) => q.id === id);
        if (!quest) return;
        quest.completed = true;
        quest.memory = memory;
        state.quests.archive.push(quest);
        state.quests.active = state.quests.active.filter((q) => q.id !== id);
        grantQuestReward(quest.reward);
        queueSave();
        render();
      }

      function grantQuestReward(reward) {
        if (!reward) return;
        if (reward.type === "decor") {
          const decorItem = DECOR_LIBRARY.find((d) => d.id === reward.id);
          if (decorItem) {
            state.room.decor.push({ id: decorItem.id, x: 0, y: 0, footprint: { w: 1, h: 1 } });
            showToast(`Decor unlocked: ${decorItem.name}`, "success");
          }
        }
        if (reward.type === "pack") {
          state.cards.collection.push({ id: `card-${Date.now()}`, rarity: "rare", bonus: { moraleCap: 1 } });
          showToast("Pack voucher added", "success");
        }
      }

      function sendCompliment(text) {
        const now = Date.now();
        const compliments = state.compliments;
        if (compliments.sentToday && new Date(compliments.lastSent).toDateString() === new Date(now).toDateString()) {
          showToast("Compliment already sent today", "info");
          return false;
        }
        compliments.sentToday = true;
        compliments.lastSent = now;
        compliments.streakUpdated = now;
        compliments.streakDays = compliments.streakDays ? compliments.streakDays + 1 : 1;
        if (compliments.streakDays % 7 === 0) {
          state.credits += 120;
          showToast("Compliment streak bonus · +120 credits", "success");
        } else {
          showToast("Compliment shared", "success");
        }
        queueSave();
        render();
        return true;
      }

      function acknowledgeCompliment() {
        const compliments = state.compliments;
        const today = new Date().toDateString();
        if (compliments.receivedToday && new Date(compliments.lastReceived).toDateString() === today) {
          showToast("Already acknowledged today", "info");
          return false;
        }
        compliments.receivedToday = true;
        compliments.lastReceived = Date.now();
        state.credits += 40;
        showToast("Compliment acknowledged · +40 credits", "success");
        queueSave();
        render();
        return true;
      }

      function handleBasicAction(action) {
        const stats = state.bear.stats;
        let delta = { energy: 0, cleanliness: 0, morale: 0 };
        switch (action) {
          case "feed":
            delta.energy = 6;
            delta.morale = 2;
            break;
          case "clean":
            delta.cleanliness = 8;
            break;
          case "play":
            delta.morale = 8;
            delta.energy = -2;
            break;
          case "rest":
            delta.energy = 10;
            delta.cleanliness = -1;
            break;
        }
        let positive = [];
        STAT_NAMES.forEach((entry) => {
          stats[entry.key] = clamp(stats[entry.key] + (delta[entry.key] || 0), 0, statMax(entry.key));
          if (delta[entry.key] > 0) positive.push(`+${delta[entry.key]} ${entry.label}`);
        });
        if (positive.length) {
          spawnFloatingText(positive.join(" · "), { x: state.bear.pos.x, y: state.bear.pos.y });
          showToast("Action applied", "info");
          trackSteadyProgress(state, 1);
          render();
          queueSave();
        }
      }

      function openContractsModal() {
        const contract = state.bear.job;
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <h2 class="text-lg font-semibold text-slate-50">Contracts</h2>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-4 space-y-4">
              ${contract && contract.id ? `
                <div class="rounded-2xl border border-slate-700/60 bg-slate-900/50 p-4">
                  <p class="text-sm text-slate-300">On duty: <strong>${CONTRACT_TYPES.find((c) => c.id === contract.id)?.label || "contract"}</strong></p>
                  <p class="text-xs text-slate-400">Ends ${formatRelative(contract.contractEndsAt)}</p>
                </div>` : ""}
              ${CONTRACT_TYPES.map((entry) => `
                <button data-id="${entry.id}" class="contract-option w-full rounded-2xl border border-slate-700/60 bg-slate-900/40 p-4 text-left transition hover:border-slate-500">
                  <div class="flex items-center justify-between">
                    <span class="text-base font-medium text-slate-100">${entry.label}</span>
                    <span class="text-sm text-emerald-300">${entry.payout} credits</span>
                  </div>
                  <p class="mt-1 text-xs text-slate-400">${entry.durationMinutes} min · drains energy ${entry.energyRate} per 5 min</p>
                </button>
              `).join("")}
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) {
            modal.remove();
          }
        });
        modal.querySelectorAll(".contract-option").forEach((btn) => {
          btn.addEventListener("click", () => {
            assignContract(btn.dataset.id);
            modal.remove();
          });
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function assignContract(id) {
        const contract = CONTRACT_TYPES.find((c) => c.id === id);
        if (!contract) return;
        if (!isAdult(state)) {
          showToast("Contracts unlock when the bear reaches adulthood", "info");
          return;
        }
        state.bear.job = {
          id: contract.id,
          contractEndsAt: Date.now() + contract.durationMinutes * 60000,
          payout: contract.payout,
          startedAt: Date.now(),
        };
        showToast(`${contract.label} secured`, "success");
        queueSave();
        render();
      }

      function openPackModal() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-3xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <h2 class="text-lg font-semibold text-slate-50">Packs</h2>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-6 grid gap-4 md:grid-cols-3">
              ${Object.entries(PACK_CATALOG).map(([key, pack]) => `
                <div class="rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
                  <h3 class="text-lg font-semibold text-slate-50">${pack.name}</h3>
                  <p class="mt-2 text-sm text-slate-400">${pack.draws} cards · ${pack.price} credits</p>
                  <ul class="mt-3 space-y-1 text-xs text-slate-400">
                    ${Object.entries(pack.odds).map(([rarity, value]) => `<li class="flex justify-between"><span class="capitalize">${rarity}</span><span>${Math.round(value * 100)}%</span></li>`).join("")}
                  </ul>
                  <button data-pack="${key}" class="open-pack mt-4 w-full rounded-full bg-slate-800/70 py-2 text-sm font-semibold text-slate-100 hover:bg-slate-700">Open</button>
                </div>
              `).join("")}
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) modal.remove();
        });
        modal.querySelectorAll(".open-pack").forEach((btn) => {
          btn.addEventListener("click", () => {
            openPack(btn.dataset.pack);
          });
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function showPackReveal(pack, pulls) {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="pack-stage glass-panel w-full max-w-3xl rounded-3xl p-8">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold text-slate-50">${pack.name}</h2>
                <p class="text-sm text-slate-400">${pulls.length} reveals</p>
              </div>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-8 grid gap-4 md:grid-cols-${pulls.length}">
              ${pulls.map((pull, index) => `
                <div class="relative h-52 w-full">
                  <div class="card-flip h-full w-full border border-slate-600/40 bg-slate-900/60" data-flipped="false" data-index="${index}">
                    <div class="card-back card-face flex items-center justify-center text-slate-200">Tap to reveal</div>
                    <div class="card-face ${RARITY_DATA[pull.rarity].border} sheen bg-slate-800/70">
                      <span class="text-sm uppercase tracking-[0.4em] text-slate-400">${RARITY_DATA[pull.rarity].label}</span>
                      <div>
                        <p class="text-lg font-semibold text-slate-50">${pull.name}</p>
                        <p class="text-xs text-slate-300">${pull.flavor || ""}</p>
                      </div>
                      ${pull.duplicate ? `<span class="text-xs text-amber-300">Duplicate → Vouchers +1</span>` : ""}
                    </div>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) modal.remove();
          const card = ev.target.closest && ev.target.closest(".card-flip");
          if (card) {
            card.dataset.flipped = "true";
          }
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function openWardrobeModal() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-4xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <h2 class="text-lg font-semibold text-slate-50">Wardrobe</h2>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-6 grid gap-4 md:grid-cols-5">
              ${["head", "neck", "body", "paws", "colorway"].map((slot) => `
                <div class="rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold capitalize text-slate-100">${slot}</h3>
                    <button data-slot="${slot}" class="unequip text-xs text-slate-400 hover:text-slate-200">None</button>
                  </div>
                  <div class="mt-3 space-y-2">
                    ${state.accessories.owned.filter((item) => item.slot === slot).map((item) => `
                      <button data-slot="${slot}" data-id="${item.id}" class="w-full rounded-2xl border ${state.accessories.equipped[slot] === item.id ? "border-emerald-400" : "border-slate-700/60"} bg-slate-800/50 p-3 text-left text-sm text-slate-200 hover:border-emerald-400/70">
                        <div class="flex items-center justify-between">
                          <span>${item.name}</span>
                          <span class="text-xs uppercase text-slate-400">${RARITY_DATA[item.rarity].label}</span>
                        </div>
                        <p class="text-xs text-slate-400">${item.flavor || ""}</p>
                      </button>
                    `).join("") || '<p class="text-xs text-slate-500">No items yet.</p>'}
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) modal.remove();
          if (ev.target.classList.contains("unequip")) {
            unequipAccessory(ev.target.dataset.slot);
          }
          const button = ev.target.closest("button[data-id]");
          if (button) {
            equipAccessory(button.dataset.slot, button.dataset.id);
          }
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function openQuestsModal() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-3xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <h2 class="text-lg font-semibold text-slate-50">Shared Quests</h2>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-4 space-y-3" id="quest-list">
              ${state.quests.active.map((quest) => `
                <div class="rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
                  <h3 class="text-base font-semibold text-slate-100">${quest.title}</h3>
                  <p class="text-sm text-slate-400">${quest.description}</p>
                  <button data-complete="${quest.id}" class="mt-3 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/30">Mark Complete</button>
                </div>
              `).join("") || '<p class="text-sm text-slate-500">Create a quest to keep things novel.</p>'}
            </div>
            <div class="mt-6 rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
              <h3 class="text-sm font-semibold text-slate-100">New Quest</h3>
              <input id="quest-title" class="mt-2 w-full rounded-2xl bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500" placeholder="Title" />
              <textarea id="quest-desc" class="mt-2 w-full rounded-2xl bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500" rows="2" placeholder="What will you do together?"></textarea>
              <button id="quest-create" class="mt-3 rounded-full bg-slate-800/70 px-3 py-1 text-xs font-semibold text-slate-100 hover:bg-slate-700">Create Quest</button>
            </div>
            <div class="mt-6 rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
              <h3 class="text-sm font-semibold text-slate-100">Compliment Tokens</h3>
              <p class="text-sm text-slate-400">Use once per day. Maintain a 7-day streak for bonuses. Positive interactions: <span class="font-semibold text-emerald-200">${state.compliments.streakDays || 0}</span></p>
              <textarea id="compliment-text" class="mt-2 w-full rounded-2xl bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500" rows="2" placeholder="Share an appreciation or gratitude"></textarea>
              <div class="mt-3 flex gap-2">
                <button id="compliment-send" class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/30">Send Compliment</button>
                <button id="compliment-ack" class="rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-200 hover:bg-amber-500/30">Acknowledge Received</button>
              </div>
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) modal.remove();
          if (ev.target.id === "quest-create") {
            const title = modal.querySelector("#quest-title").value.trim();
            const desc = modal.querySelector("#quest-desc").value.trim();
            sharedQuestCreate({ title: title || undefined, description: desc || undefined });
            modal.remove();
          }
          if (ev.target.dataset && ev.target.dataset.complete) {
            sharedQuestComplete(ev.target.dataset.complete, { note: "Marked complete" });
            modal.remove();
          }
          if (ev.target.id === "compliment-send") {
            const text = modal.querySelector("#compliment-text").value.trim();
            if (text.length > 0) {
              sendCompliment(text);
            }
          }
          if (ev.target.id === "compliment-ack") {
            acknowledgeCompliment();
          }
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function openSettingsModal() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-lg rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <h2 class="text-lg font-semibold text-slate-50">Settings</h2>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-4 space-y-4 text-sm">
              <label class="flex items-center justify-between">
                <span>Show KJV verse</span>
                <input type="checkbox" id="settings-kjv" ${state.settings.showKJV ? "checked" : ""} />
              </label>
              <label class="flex items-center justify-between">
                <span>SFX Volume</span>
                <input type="range" min="0" max="1" step="0.05" id="settings-sfx" value="${state.settings.sfx}" />
              </label>
              <label class="flex items-center justify-between">
                <span>Music Volume</span>
                <input type="range" min="0" max="1" step="0.05" id="settings-music" value="${state.settings.music}" />
              </label>
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) {
            modal.remove();
            return;
          }
        });
        modal.querySelector("#settings-kjv").addEventListener("change", (ev) => {
          state.settings.showKJV = ev.target.checked;
          render();
          queueSave();
        });
        modal.querySelector("#settings-sfx").addEventListener("input", (ev) => {
          state.settings.sfx = Number(ev.target.value);
          queueSave();
        });
        modal.querySelector("#settings-music").addEventListener("input", (ev) => {
          state.settings.music = Number(ev.target.value);
          queueSave();
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function openMiniGameModal(game) {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold text-slate-50">${game.name}</h2>
                <p class="text-sm text-slate-400">${game.desc}</p>
              </div>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <canvas id="mini-game-canvas" class="mt-6 h-48 w-full rounded-3xl bg-slate-950/70"></canvas>
            <button id="mini-game-play" class="mt-6 w-full rounded-full bg-emerald-500/20 py-2 text-sm font-semibold text-emerald-200 hover:bg-emerald-500/30">Start</button>
          </div>
        `;
        const canvas = modal.querySelector("#mini-game-canvas");
        const ctx = canvas.getContext("2d");
        let running = false;
        const moraleBonus = state.bear.stats.morale >= 80 ? 1.1 : 1;
        canvas.width = 600;
        canvas.height = 180;

        function drawRhythm(timestamp) {
          if (!running) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#1e293b";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#38bdf8";
          const beat = (timestamp / 400) % canvas.width;
          ctx.fillRect(beat, 0, 6, canvas.height);
          requestAnimationFrame(drawRhythm);
        }

        function drawFishing(timestamp) {
          if (!running) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#0f172a";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          const zoneWidth = 80;
          const zoneX = canvas.width / 2 - zoneWidth / 2;
          ctx.fillStyle = "#22d3ee";
          ctx.fillRect(zoneX, 30, zoneWidth, 120);
          const pointer = (Math.sin(timestamp / 300) * 0.5 + 0.5) * (canvas.width - 40) + 20;
          ctx.fillStyle = "#f59e0b";
          ctx.fillRect(pointer, 20, 4, 140);
          requestAnimationFrame(drawFishing);
        }

        function drawCourier(timestamp) {
          if (!running) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#0f172a";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          const laneHeight = canvas.height / 3;
          ctx.fillStyle = "#1e293b";
          for (let i = 1; i < 3; i++) {
            ctx.fillRect(0, laneHeight * i - 1, canvas.width, 2);
          }
          ctx.fillStyle = "#f97316";
          const playerLane = Math.floor((timestamp / 600) % 3);
          ctx.fillRect(40, laneHeight * playerLane + 20, 32, 32);
          requestAnimationFrame(drawCourier);
        }

        modal.querySelector("#mini-game-play").addEventListener("click", () => {
          if (running) return;
          running = true;
          const end = Date.now() + 60000;
          const loop = () => {
            if (!running) return;
            const remaining = end - Date.now();
            if (remaining <= 0) {
              running = false;
              const payout = Math.floor(90 * moraleBonus);
              state.credits += payout;
              state.miniGames.playsToday[game.id] = (state.miniGames.playsToday[game.id] || 0) + 1;
              state.miniGames.lastPlayedAt[game.id] = Date.now();
              if (game.id === "rhythm" && payout >= 99) {
                state.miniGames.history.rhythmPerfect = true;
              }
              showToast(`${game.name} complete · +${payout} credits`, "success");
              modal.remove();
              queueSave();
              render();
              return;
            }
            modal.querySelector("#mini-game-play").textContent = `Playing · ${Math.ceil(remaining / 1000)}s`;
            requestAnimationFrame(loop);
          };
          switch (game.id) {
            case "rhythm":
              requestAnimationFrame(drawRhythm);
              break;
            case "fish":
              requestAnimationFrame(drawFishing);
              break;
            case "courier":
              requestAnimationFrame(drawCourier);
              break;
          }
          requestAnimationFrame(loop);
        });
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) {
            running = false;
            modal.remove();
          }
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function render() {
        document.getElementById("bear-name").textContent = state.bear.name;
        const rarity = RARITY_DATA[state.bear.rarity] || RARITY_DATA.common;
        const rarityBadge = document.getElementById("bear-rarity");
        rarityBadge.textContent = rarity.label;
        rarityBadge.className = `rounded-full px-3 py-1 text-xs uppercase tracking-wide ${rarity.badge}`;
        document.getElementById("bear-stage").textContent = state.bear.stage.toUpperCase();
        document.getElementById("bear-duty").textContent = isOnDuty(state) ? "On Duty" : "Off Duty";
        document.getElementById("bear-duty").className = `rounded-full px-3 py-1 text-xs uppercase tracking-wide ${isOnDuty(state) ? "border border-emerald-500/60 text-emerald-200" : "border border-slate-600/60 text-slate-300"}`;
        document.getElementById("credits").textContent = Math.floor(state.credits);
        document.getElementById("vouchers").textContent = state.vouchers;
        renderStats();
        renderMiniGames();
        renderMilestones();
        renderDecor();
        renderVerse();
      }

      function renderStats() {
        const statsWrapper = document.getElementById("stats");
        statsWrapper.innerHTML = "";
        STAT_NAMES.forEach((entry) => {
          const value = Math.round(state.bear.stats[entry.key]);
          const max = statMax(entry.key);
          const percent = Math.max(0, Math.min(100, (value / max) * 100));
          const container = document.createElement("div");
          container.innerHTML = `
            <div class="flex items-center justify-between text-xs text-slate-400">
              <span>${entry.label}</span>
              <span>${value} / ${max}</span>
            </div>
            <div class="stat-bar mt-1 h-3 w-full overflow-hidden rounded-full bg-slate-900/60">
              <div class="h-full bg-gradient-to-r ${entry.tone}" style="width: ${percent}%"></div>
            </div>
          `;
          statsWrapper.appendChild(container);
        });
      }

      function renderMiniGames() {
        const list = document.getElementById("mini-game-list");
        list.innerHTML = "";
        let totalToday = Object.values(state.miniGames.playsToday).reduce((a, b) => a + b, 0);
        document.getElementById("sidegig-remaining").textContent = `${Math.max(0, 5 - totalToday)} left today`;
        MINI_GAMES.forEach((game) => {
          const plays = state.miniGames.playsToday[game.id] || 0;
          const card = document.createElement("button");
          card.disabled = game.stub;
          card.className = `text-left rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4 transition hover:border-slate-500 ${game.stub ? "opacity-60" : ""}`;
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-100">${game.name}</p>
                <p class="text-xs text-slate-400">${game.desc}</p>
              </div>
              <span class="text-xs text-slate-400">${plays}/${game.maxPerDay}${game.stub ? " · Soon" : ""}</span>
            </div>
          `;
          if (!game.stub) {
            card.addEventListener("click", () => playMiniGame(game.id));
          }
          list.appendChild(card);
        });
      }

      function renderMilestones() {
        const container = document.getElementById("milestones");
        container.innerHTML = "";
        Object.entries(MILESTONE_DEFS).forEach(([key, milestone]) => {
          const status = state.milestones[key] || { unlocked: false, claimed: false };
          const unlocked = milestone.check(state);
          if (unlocked && !status.unlocked) {
            state.milestones[key] = { unlocked: true, claimed: status.claimed || false };
            status.unlocked = true;
            showToast(`Milestone unlocked: ${milestone.name}`, "success");
          }
          const finalStatus = state.milestones[key] || status;
          const row = document.createElement("div");
          row.className = "rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4";
          row.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-100">${milestone.name}</p>
                <p class="text-xs text-slate-400">${milestone.description}</p>
              </div>
              <span class="text-xs text-emerald-200">${milestone.reward}</span>
            </div>
            <div class="mt-2 text-xs text-slate-400">${unlocked ? (finalStatus.claimed ? "Claimed" : "Ready") : "In progress"}</div>
          `;
          if (unlocked && !finalStatus.claimed) {
            const btn = document.createElement("button");
            btn.textContent = "Claim";
            btn.className = "mt-3 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/30";
            btn.addEventListener("click", () => {
              claimMilestone(key, milestone.reward);
            });
            row.appendChild(btn);
          }
          container.appendChild(row);
        });
      }

      function renderVerse() {
        const verseLine = document.getElementById("kjv-line");
        if (state.settings.showKJV) {
          const verse = state.versesKJV[Math.floor(Math.random() * state.versesKJV.length)];
          verseLine.textContent = verse || "";
          verseLine.classList.remove("hidden");
        } else {
          verseLine.classList.add("hidden");
        }
      }

      function renderDecor() {
        roomGrid.querySelectorAll(".decor-item").forEach((node) => node.remove());
        const rect = roomGrid.getBoundingClientRect();
        const tileW = rect.width / GRID_CONFIG.cols;
        const tileH = rect.height / GRID_CONFIG.rows;
        if (!tileW || !tileH) return;
        state.room.decor.forEach((decor, index) => {
          const item = DECOR_LIBRARY.find((d) => d.id === decor.id);
          const node = document.createElement("div");
          node.className = "decor-item";
          node.dataset.index = index;
          node.style.left = `${decor.x * tileW + tileW * 0.1}px`;
          node.style.top = `${decor.y * tileH + tileH * 0.1}px`;
          node.style.zIndex = 10 + decor.y;
          node.textContent = item ? item.name.split(" ")[0] : decor.id;
          node.addEventListener("pointerdown", (ev) => {
            if (ev.button !== 0) return;
            ev.preventDefault();
            startDecorDrag({ mode: "move", index, item });
            updateDecorGhost(ev.clientX, ev.clientY);
          });
          roomGrid.appendChild(node);
        });
      }

      function claimMilestone(key, reward) {
        const status = state.milestones[key] || { unlocked: false, claimed: false };
        if (status.claimed) return;
        state.milestones[key] = { unlocked: true, claimed: true };
        if (reward.includes("Credits")) {
          const amount = parseInt(reward.replace(/[^0-9]/g, ""), 10) || 0;
          state.credits += amount;
        }
        if (reward.includes("Standard Pack")) {
          showToast("Standard pack granted", "success");
          grantPack("standard");
        }
        if (reward.includes("Elite Decor")) {
          state.room.decor.push({ id: "espresso", x: 1, y: 1, footprint: { w: 1, h: 1 } });
          showToast("Elite decor delivered", "success");
        }
        queueSave();
        render();
      }

      function grantPack(type) {
        const pack = PACK_CATALOG[type];
        if (!pack) return;
        const pulls = [];
        for (let i = 0; i < pack.draws; i++) {
          const rarity = rollRarity(pack.odds);
          const pool = ACCESSORY_LIBRARY.filter((item) => item.rarity === rarity);
          const drawn = pool[Math.floor(Math.random() * pool.length)] || ACCESSORY_LIBRARY[Math.floor(Math.random() * ACCESSORY_LIBRARY.length)];
          const owned = state.accessories.owned.find((item) => item.id === drawn.id);
          if (!owned) {
            state.accessories.owned.push({ ...drawn });
            pulls.push({ ...drawn, duplicate: false });
          } else {
            state.vouchers += 1;
            pulls.push({ ...drawn, duplicate: true });
          }
        }
        queueSave();
        render();
        showPackReveal(pack, pulls);
      }

      function openDecorModal() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-6";
        modal.innerHTML = `
          <div class="glass-panel w-full max-w-2xl rounded-3xl p-6">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold text-slate-50">Decor Inventory</h2>
                <p class="text-sm text-slate-400">Drag an item into the den to place it.</p>
              </div>
              <button class="text-slate-400 hover:text-slate-100" id="modal-close">Close</button>
            </div>
            <div class="mt-4 grid gap-3 md:grid-cols-2">
              ${DECOR_LIBRARY.map((item) => `
                <div class="rounded-3xl border border-slate-700/60 bg-slate-900/40 p-4">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-slate-100">${item.name}</h3>
                    <span class="text-xs text-slate-400">${item.boosts.moraleCap ? `+${item.boosts.moraleCap} morale cap` : "Room accent"}</span>
                  </div>
                  <button data-id="${item.id}" class="mt-3 w-full rounded-full bg-slate-800/70 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 hover:bg-slate-700">Drag to Place</button>
                </div>
              `).join("")}
            </div>
          </div>
        `;
        modal.addEventListener("click", (ev) => {
          if (ev.target.id === "modal-close" || ev.target === modal) modal.remove();
        });
        modal.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("pointerdown", (ev) => {
            const item = DECOR_LIBRARY.find((d) => d.id === btn.dataset.id);
            if (!item) return;
            ev.preventDefault();
            startDecorDrag({ mode: "new", item });
            updateDecorGhost(ev.clientX, ev.clientY);
            modal.remove();
          });
        });
        document.getElementById("modal-root").appendChild(modal);
      }

      function startDecorDrag(payload) {
        decorDrag = payload;
        if (decorGhost) decorGhost.remove();
        decorGhost = document.createElement("div");
        decorGhost.className = "decor-item pointer-events-none opacity-70";
        decorGhost.style.position = "fixed";
        decorGhost.style.left = "0px";
        decorGhost.style.top = "0px";
        decorGhost.style.transform = "translate(-44px, -44px)";
        decorGhost.textContent = payload.item ? payload.item.name.split(" ")[0] : "Move";
        document.body.appendChild(decorGhost);
      }

      function updateDecorGhost(x, y) {
        if (!decorGhost) return;
        decorGhost.style.left = `${x}px`;
        decorGhost.style.top = `${y}px`;
      }

      function completeDecorDrag(x, y) {
        if (!decorDrag) return;
        const rect = roomGrid.getBoundingClientRect();
        const inside = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
        if (inside) {
          const tileW = rect.width / GRID_CONFIG.cols;
          const tileH = rect.height / GRID_CONFIG.rows;
          const gridX = Math.max(0, Math.min(GRID_CONFIG.cols - 1, Math.floor((x - rect.left) / tileW)));
          const gridY = Math.max(0, Math.min(GRID_CONFIG.rows - 1, Math.floor((y - rect.top) / tileH)));
          if (decorDrag.mode === "new") {
            state.room.decor.push({ id: decorDrag.item.id, x: gridX, y: gridY, footprint: { w: 1, h: 1 } });
            showToast(`${decorDrag.item.name} placed`, "success");
          } else if (decorDrag.mode === "move" && typeof decorDrag.index === "number") {
            const target = state.room.decor[decorDrag.index];
            if (target) {
              target.x = gridX;
              target.y = gridY;
              showToast("Decor repositioned", "info");
            }
          }
          queueSave();
          render();
        }
        if (decorGhost) {
          decorGhost.remove();
          decorGhost = null;
        }
        decorDrag = null;
      }

      function showDecorMenu(index, x, y) {
        if (decorMenu) decorMenu.remove();
        decorMenu = document.createElement("div");
        decorMenu.className = "glass-panel fixed z-50 rounded-2xl px-4 py-3 text-sm text-slate-200";
        decorMenu.style.left = `${x}px`;
        decorMenu.style.top = `${y}px`;
        decorMenu.innerHTML = `
          <div class="flex flex-col gap-2">
            <button class="move-option text-left text-xs uppercase tracking-wide text-emerald-200">Move</button>
            <button class="sell-option text-left text-xs uppercase tracking-wide text-amber-200">Sell (+60 credits)</button>
          </div>
        `;
        const closeMenu = (ev) => {
          if (!decorMenu) {
            document.removeEventListener("pointerdown", closeMenu);
            return;
          }
          if (!decorMenu.contains(ev.target)) {
            decorMenu.remove();
            decorMenu = null;
            document.removeEventListener("pointerdown", closeMenu);
          }
        };
        decorMenu.querySelector(".move-option").addEventListener("click", () => {
          const item = state.room.decor[index];
          if (!item) return;
          const catalog = DECOR_LIBRARY.find((d) => d.id === item.id);
          startDecorDrag({ mode: "move", index, item: catalog });
          if (decorMenu) decorMenu.remove();
          decorMenu = null;
          document.removeEventListener("pointerdown", closeMenu);
        });
        decorMenu.querySelector(".sell-option").addEventListener("click", () => {
          const [removed] = state.room.decor.splice(index, 1);
          if (removed) {
            state.credits += 60;
            showToast("Decor sold", "success");
            queueSave();
            render();
          }
          if (decorMenu) decorMenu.remove();
          decorMenu = null;
          document.removeEventListener("pointerdown", closeMenu);
        });
        document.body.appendChild(decorMenu);
        document.addEventListener("pointerdown", closeMenu);
      }

      function createBearSprite() {
        const el = document.createElement("div");
        el.className = "bear-sprite";
        el.dataset.facing = "right";
        return el;
      }

      function spawnFloatingText(text, gridPos) {
        const floating = document.createElement("div");
        floating.className = "floating-text text-sm font-semibold text-emerald-200";
        floating.textContent = text;
        const rect = document.getElementById("room-grid").getBoundingClientRect();
        floating.style.left = `${rect.left + (gridPos.x / GRID_CONFIG.cols) * rect.width}px`;
        floating.style.top = `${rect.top + (gridPos.y / GRID_CONFIG.rows) * rect.height}px`;
        document.body.appendChild(floating);
        setTimeout(() => floating.remove(), 800);
      }

      function showToast(message, tone = "info") {
        const root = document.getElementById("toast-root");
        const toast = document.createElement("div");
        const toneClass = {
          info: "bg-slate-800/90 text-slate-200",
          success: "bg-emerald-600/30 text-emerald-100",
          warn: "bg-amber-500/20 text-amber-100",
        }[tone] || "bg-slate-800/90 text-slate-200";
        toast.className = `glass-panel toast-enter rounded-full px-4 py-2 text-sm ${toneClass}`;
        toast.textContent = message;
        root.appendChild(toast);
        setTimeout(() => toast.remove(), 3200);
      }

      function queueSave() {
        saveQueued = true;
      }

      function writeSave() {
        state.meta.lastSaved = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (firebaseMirror) {
          firebaseMirror.save(state);
        }
      }

      function mainLoop(timestamp) {
        const delta = timestamp - lastFrame;
        lastFrame = timestamp;
        realtimeAccumulator += delta;
        roomEngine.update(delta);
        bearAnimator.update(delta);
        if (realtimeAccumulator >= 60000) {
          const minutes = Math.floor(realtimeAccumulator / 60000);
          realtimeAccumulator -= minutes * 60000;
          applyRealtimeDecay(minutes);
        }
        if (saveQueued) {
          saveQueued = false;
          writeSave();
        }
        requestAnimationFrame(mainLoop);
      }

      function applyRealtimeDecay(minutes) {
        const stats = state.bear.stats;
        const contractActive = state.bear.job && state.bear.job.id && Date.now() < state.bear.job.contractEndsAt;
        const rate = contractActive ? 1 / 5 : 1 / 10;
        const decay = minutes * rate;
        stats.energy = clamp(stats.energy - decay, 0, statMax("energy"));
        stats.cleanliness = clamp(stats.cleanliness - decay, 0, statMax("cleanliness"));
        stats.morale = clamp(stats.morale - decay, 0, statMax("morale"));
        state.bear.ageMinutes += minutes;
        updateBearStage(state);
        trackSteadyProgress(state, minutes);
        if (contractActive && Date.now() >= state.bear.job.contractEndsAt) {
          state.credits += state.bear.job.payout;
          state.stats.contractsCompleted = (state.stats.contractsCompleted || 0) + 1;
          showToast(`Contract complete · +${state.bear.job.payout} credits`, "success");
          state.bear.job = { id: null, contractEndsAt: 0, payout: 0, startedAt: 0 };
        }
        if (isOnDuty(state)) {
          state.credits += incomePerMinute(state) * minutes;
        }
        render();
      }

      function updateBearStage(state) {
        const minutes = state.bear.ageMinutes;
        if (minutes < 60) state.bear.stage = "cub";
        else if (minutes < 180) state.bear.stage = "teen";
        else state.bear.stage = "adult";
      }

      function trackSteadyProgress(state, minutes) {
        const stats = state.bear.stats;
        if (stats.energy >= 70 && stats.cleanliness >= 70 && stats.morale >= 70) {
          state.stats.steadyMinutes = (state.stats.steadyMinutes || 0) + minutes;
        }
      }

      function isOnDuty(state) {
        return state.bear.stats.energy >= 60 && state.bear.stats.cleanliness >= 60 && state.bear.stats.morale >= 60;
      }

      function isAdult(state) {
        return state.bear.stage === "adult";
      }

      function statMax(key) {
        let max = 100;
        state.room.decor.forEach((decor) => {
          const item = DECOR_LIBRARY.find((d) => d.id === decor.id);
          if (item && item.boosts) {
            if (key === "morale" && item.boosts.moraleCap) max += item.boosts.moraleCap;
            if (key === "energy" && item.boosts.energyCap) max += item.boosts.energyCap;
            if (key === "cleanliness" && item.boosts.cleanCap) max += item.boosts.cleanCap;
          }
        });
        if (key === "morale" && state.accessories.equipped.neck === "band") max += 2;
        if (key === "morale" && state.accessories.equipped.head === "fedora") max += 2;
        return Math.round(max);
      }

      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }

      function formatRelative(timestamp) {
        const diff = timestamp - Date.now();
        if (diff <= 0) return "completed";
        const minutes = Math.round(diff / 60000);
        if (minutes < 60) return `${minutes} min`; 
        const hours = Math.round(minutes / 60);
        return `${hours} h`;
      }

      function applyRealtimeFirebase(state) {}

      async function initFirebase(config) {
        const appScript = document.createElement("script");
        appScript.src = `https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js?v=${BUILD_VERSION}`;
        const firestoreScript = document.createElement("script");
        firestoreScript.src = `https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js?v=${BUILD_VERSION}`;
        document.head.appendChild(appScript);
        await new Promise((resolve) => (appScript.onload = resolve));
        document.head.appendChild(firestoreScript);
        await new Promise((resolve) => (firestoreScript.onload = resolve));
        const app = firebase.initializeApp(config);
        const db = firebase.firestore(app);
        firebaseMirror = {
          save(payload) {
            if (!state.meta.homeCode) return;
            db.collection("teamBearHomes").doc(state.meta.homeCode).set(payload, { merge: true }).catch((err) => console.warn(err));
          },
        };
      }
    </script>
  </body>
</html>
